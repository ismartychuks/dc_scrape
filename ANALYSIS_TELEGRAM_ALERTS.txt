â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          ğŸ” ROOT CAUSE ANALYSIS: WHY TELEGRAM ALERTS AREN'T WORKING          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

INVESTIGATION FINDINGS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š USER STATUS (from bot_users.json):

User 1220056877:
  âœ“ Subscribed until: 2025-12-24
  âœ— ALERTS_PAUSED: true  â† THIS IS THE ISSUE!
  
User 6512032932:
  âœ“ Subscribed until: 2026-02-15
  âœ“ Alerts not paused: false
  â†’ This user SHOULD receive alerts


THE ROOT ISSUE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

The broadcast_job logic uses: sm.get_active_users()

This function FILTERS OUT users where alerts_paused = true

So even if messages are being polled correctly, they won't be sent to:
  â€¢ User 1220056877 (paused)
  â€¢ Any other users who have paused alerts

But WILL be sent to:
  â€¢ User 6512032932 (active and not paused)


FLOW VERIFICATION
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Code analysis of broadcast_job (lines 726-776):

1. Call poller.poll_new_messages()
   â””â”€ Queries Supabase for messages with scraped_at > last_time
   â””â”€ Returns: List of new messages (if any)

2. Check if messages found
   â””â”€ If not: return (exit early)
   â””â”€ If yes: continue

3. Get active users: sm.get_active_users()
   â””â”€ This filters: only users where NOT paused AND NOT expired
   â””â”€ USER 1220056877: FILTERED OUT (paused=true)
   â””â”€ USER 6512032932: KEPT

4. For each message, send to each active user
   â””â”€ Format message
   â””â”€ Send via Telegram API

5. Track sent messages to avoid duplicates
   â””â”€ Hash-based dedup in poller.sent_hashes


POSSIBLE SCENARIOS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âŒ SCENARIO A: Bot not running at all
   Symptoms: No broadcast_job executing
   Evidence needed: Check logs for bot startup message
   Fix: Verify wsgi.py thread is created

âœ… SCENARIO B: Bot running but no messages to send
   Symptoms: broadcast_job runs but finds no new messages
   Cause: Messages already sent (in sent_hashes) OR app.py not uploading
   Fix: Check Supabase for new messages

âœ… SCENARIO C: Messages found but only paused users
   Symptoms: broadcast_job sees messages but no active users
   Cause: User 1220056877 has alerts_paused=true
   Fix: User must /toggle_alerts to resume

âš ï¸  SCENARIO D: Bot can't send to user (right permissions/token)
   Symptoms: broadcast_job tries to send but fails
   Cause: Invalid token, user blocked bot, etc.
   Evidence: Error logs with "Send fail to [userid]"
   Fix: Check bot token and user has /start the bot


HOW TO DIAGNOSE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… STEP 1: Enable Debug Logging
   Look for these log messages:

   [telegram_bot] INFO - ğŸ“¤ Broadcasting X messages to Y users
   [telegram_bot] INFO - âœ… Message sent to [user_id]
   [telegram_bot] ERROR - Send fail to [user_id]: [error]

âœ… STEP 2: Check Active Users Count
   sm.get_active_users() should return:
   - User 6512032932 only (not user 1220056877)

âœ… STEP 3: Check Message Polling
   poller.poll_new_messages() should return:
   - Subset of messages not in poller.sent_hashes

âœ… STEP 4: Check Bot Thread
   Should see in logs on startup:
   "Telegram bot started in background thread"

âœ… STEP 5: Check Message Format
   Messages from Supabase should have:
   - content, raw_data, scraped_at fields


CURRENT STATE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ“ bot_users.json has 2 registered users
âœ“ 1 user is active (6512032932)
âœ“ 1 user has paused alerts (1220056877)
âœ“ wsgi.py spawns bot thread correctly
âœ“ broadcast_job code looks correct

âš ï¸  UNKNOWNS:
   â€¢ Are messages actually being uploaded to Supabase?
   â€¢ Is bot thread actually running?
   â€¢ Is broadcast_job triggering every 10 seconds?
   â€¢ Are messages being found by poller?


NEXT DEBUG STEPS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. Run diagnostic script:
   python DIAGNOSTIC_BOT.py
   
   This will check:
   â€¢ How many active users
   â€¢ What messages are in Supabase
   â€¢ When last_scraped_at was updated
   â€¢ If poller can find new messages

2. Watch logs while app is running:
   python app.py 2>&1 | grep -i "broadcast\|telegram\|send"
   
   Should see every 10 seconds:
   - "Broadcasting X messages" OR
   - "No new messages to broadcast"

3. Check Supabase directly:
   â€¢ Do messages exist in discord_messages table?
   â€¢ What's the latest scraped_at timestamp?
   â€¢ Are they being uploaded recently?

4. Test message sending manually:
   â€¢ Create test script
   â€¢ Use Telegram API directly
   â€¢ Send test message to verify bot works


KEY INSIGHT
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

The code looks correct. The most likely issues are:

1. Bot thread not actually running (despite wsgi.py code)
2. Messages not being uploaded to Supabase (app.py issue)
3. No new messages since last_scraped_at (duplicate filtering)
4. User 1220056877 legitimately has paused alerts

User 6512032932 SHOULD be receiving alerts IF:
âœ“ Messages are in Supabase
âœ“ Bot thread is running
âœ“ broadcast_job is triggering
âœ“ Telegram token is valid

